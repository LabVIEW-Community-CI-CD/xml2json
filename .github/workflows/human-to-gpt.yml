name: Human ‚Üî GPT Intake
on:
  workflow_dispatch:
    inputs:
      payload_raw:
        description: 'Loosely‚Äëformatted JSON string ("timestamp" may be empty)'
        required: true
        default: |
          {
            "phase": "inbox",
            "conversation_id": "xml2json-intake-001",
            "timestamp": "",
            "role": "user",
            "content": "Please ingest gpt/issues/_intake_payload.md and create GitHub issues."
          }
        type: string

permissions:
  contents: write
  issues: write

jobs:
  intake:
    runs-on: [self-hosted, windows]
    timeout-minutes: 90
    defaults:
      run:
        shell: pwsh

    steps:
      # 1¬†‚Äì¬†Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2¬†‚Äì¬†Ensure inbox directory
      - name: Ensure inbox directory exists
        run: |
          New-Item -ItemType Directory -Path gpt/inbox -Force

      # 3¬†‚Äì¬†Setup Node (for AJV)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 4¬†‚Äì¬†Parse + validate payload
      - name: Parse and validate input
        id: validate
        env:
          PAYLOAD_RAW: ${{ github.event.inputs.payload_raw }}
        run: |
          $ErrorActionPreference = 'Stop'
          $payload = ConvertFrom-Json -InputObject $env:PAYLOAD_RAW
          if (-not $payload.PSObject.Properties['timestamp']) {
            $payload | Add-Member -NotePropertyName timestamp -NotePropertyValue ''
          }
          $payload.timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          if ($payload.phase -ne 'inbox') { Write-Error "‚ùå phase must be 'inbox'." }
          npm install -g ajv-cli@5 ajv-formats@2 | Out-Null
          $temp = Join-Path $env:RUNNER_TEMP 'payload.json'
          $payload | ConvertTo-Json -Depth 10 | Out-File -Encoding utf8 -FilePath $temp
          ajv validate -c ajv-formats -s gpt/schemas/intake-v1.json -d $temp
          $inboxPath = "gpt/inbox/${{ github.run_number }}.json"
          Copy-Item -Path $temp -Destination $inboxPath

      # 5¬†‚Äì¬†Upload artifact
      - name: Upload intake artifact
        uses: actions/upload-artifact@v4
        with:
          name: gpt-intake-${{ github.run_number }}
          path: gpt/inbox/${{ github.run_number }}.json

      # 6¬†‚Äì¬†Commit & push (PR fallback)
      - name: Commit & push (PR fallback)
        id: commit
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gpt/inbox
          git commit -m "ü§ñ GPT intake: add payload ${{ github.run_number }}" 2>$null
          git push origin HEAD:main 2>$null
          if ($LASTEXITCODE -eq 0) {
            "PR_URL=" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            $branch = "gpt-input-${{ github.run_number }}"
            git push -u origin HEAD:$branch
            $pr = gh pr create --base main --head $branch --title "GPT Intake ${{ github.run_number }}" --body "Automated intake PR"
            "PR_URL=$pr" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      # 7¬†‚Äì¬†Open tracking issue
      - name: Open tracking issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ steps.commit.outputs.PR_URL }}
        run: |
          $ts = "${{ github.run_number }}"
          $instruction = @"
          **Action required ‚Üí**  
          Copy **this entire block** (including this line) and paste it as a **new comment** on this issue.  
          _Do not add or remove anything._¬†¬†The CI job resumes when it detects an exact‚Äëmatch comment.
          "@
          if ($env:PR_URL) {
            $body = "Payload timestamp: $ts`n`nRelated PR: $env:PR_URL`n`n$instruction"
          } else {
            $body = "Payload timestamp: $ts`n`n$instruction"
          }
          $issue = gh issue create --title "GPT Intake $ts" --body $body --label "gpt-intake"
          $num = $issue -replace '.*/', ''
          "ISSUE_NUMBER=$num" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      # 8¬†‚Äì¬†Wait for exact‚Äëmatch comment (robust normalization)
      - name: Wait for matching comment (max 60¬†min)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.issue.outputs.ISSUE_NUMBER }}
        run: |
          function Normalize([string]$s) { return ($s -replace "`r", "").TrimEnd() }
          $expected = Normalize (gh issue view $env:ISSUE_NUMBER --json body --jq ".body")
          for ($i = 1; $i -le 60; $i++) {
            Write-Output "Polling issue #$env:ISSUE_NUMBER (attempt $i/60)‚Ä¶"
            $comments = gh issue view $env:ISSUE_NUMBER --json comments --jq ".comments[].body"
            foreach ($c in $comments) {
              if (Normalize $c -eq $expected) {
                Write-Output "‚úÖ Matching comment detected ‚Äì workflow continues."
                exit 0
              }
            }
            Start-Sleep -Seconds 60
          }
          Write-Error "‚ùå No matching comment after 60¬†minutes ‚Äì failing job."
